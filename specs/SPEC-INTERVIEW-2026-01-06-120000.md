# Spec Interview: Recording Grace Period Feature

**Date**: 2026-01-06
**Feature**: Post-release grace period for audio recording

## Overview

Users occasionally miss the last phrase of their speech when releasing the hotkey slightly too early. This feature adds a configurable grace period that continues recording for a short duration after the user releases the trigger key, ensuring the final words are captured.

## Requirements

### Functional Requirements

1. **Grace Period Duration**: Recording continues for an additional period after key release, equal to the minimum hold duration setting (default 300ms)
2. **Seamless Experience**: The grace period should be invisible to the user - no UI changes during the grace period
3. **Re-press Handling**: If the user releases and re-presses within the grace period, treat it as one continuous recording
4. **Hard Cutoff**: Recording stops at grace period end regardless of ongoing speech (no VAD extension)
5. **Focus Independence**: Grace period timer always completes regardless of app focus or event tap status

### Non-Functional Requirements

1. **No additional feedback**: No audio/haptic cue when grace period ends
2. **Automatic sync**: Grace period duration automatically matches minimum hold duration setting
3. **No upper cap**: Grace period follows hold duration setting with no maximum limit
4. **Debug logging**: Add debug-level logs for grace period start/end events

## Technical Decisions

### Architecture

- **Ownership**: ShortcutManager owns the grace period timer
- **Flow Change**: ShortcutManager delays calling `delegate.onRecordingStop()` until grace period completes
- **Audio Service**: AudioCaptureService requires no changes - it simply receives the stop signal later

### State Transitions

```
[Key Pressed] → [Recording Active] → [Key Released] → [Grace Period Active] → [Recording Stopped]
                                           ↓                    ↑
                                    [Key Re-pressed] ──────────┘
                                    (continues recording)
```

### Key Implementation Details

1. **ShortcutManager changes**:
   - On key release during active recording, start grace period timer instead of immediately stopping
   - Track `isInGracePeriod` state
   - If key is re-pressed during grace period, cancel timer and continue recording normally
   - On timer completion, call `delegate.onRecordingStop()`

2. **Timer Management**:
   - Use `DispatchSourceTimer` or `Timer` with 300ms (or configured hold duration)
   - Timer runs independently of event tap status
   - Timer must be cancelled if key is re-pressed

3. **Transcription Timing**:
   - Transcription is triggered only after grace period completes
   - All audio (including grace period audio) is sent as one batch

### Paste Target Behavior

- Text is pasted into the application that is focused when transcription completes
- This means if user switches apps during grace period, text goes to new app
- This matches user expectation: "I released the key and switched apps, so paste there"

## Data Model

No data model changes required. The grace period is derived from existing `minimumHoldDuration` configuration value.

## User Flows

### Happy Path

1. User presses trigger key
2. Recording starts after minimum hold duration (300ms)
3. User speaks: "Send the report to accounting"
4. User releases key (possibly slightly early)
5. Grace period of 300ms begins (invisible to user)
6. Recording indicator remains unchanged
7. Grace period ends
8. Recording stops, audio sent for transcription
9. Full phrase "Send the report to accounting" is captured

### Re-press During Grace Period

1. User presses and holds trigger key, recording starts
2. User releases key, grace period begins
3. User immediately re-presses key (within 300ms)
4. Grace period timer is cancelled
5. Recording continues seamlessly as if release never happened
6. User releases key again
7. New grace period begins
8. Grace period completes, recording stops

### App Switch During Grace Period

1. User is in TextEdit, presses trigger key, speaks
2. User releases key, grace period begins
3. User Cmd+Tab to Safari during grace period
4. Grace period ends, recording stops
5. Transcription completes
6. Text is pasted into Safari (current focused app)

## Edge Cases

| Scenario | Behavior |
|----------|----------|
| Key re-pressed during grace period | Cancel grace timer, continue recording seamlessly |
| App loses focus during grace period | Timer continues, recording completes normally |
| Event tap interrupted during grace period | Timer completes (runs independently of event tap) |
| System sleep during grace period | Discard recording (don't transcribe partial audio) |
| Audio device unplugged during grace period | Discard recording |
| App force quit during grace period | Recording lost (expected behavior) |
| User changes hold duration setting | Grace period updates immediately for next recording |
| Very long hold duration (e.g., 2 seconds) | Grace period matches (no cap) |

## Error Handling

| Failure Mode | Recovery Strategy |
|--------------|-------------------|
| Timer fails to fire | Fallback: immediate stop on release (degrade gracefully) |
| Audio buffer overflow during grace | Continue with available audio, log warning |
| System interruption during grace | Discard recording entirely |

## Testing Strategy

### Core Test Scenarios

1. **Basic grace period**: Verify recording continues for configured duration after key release
2. **Re-press during grace**: Verify seamless continuation when key is re-pressed
3. **Interruption handling**: Verify recording is discarded on system interruption

### Test Implementation Notes

- Mock timer for deterministic testing
- Test state transitions in ShortcutManager
- Verify timer cancellation on re-press

## Out of Scope

- VAD-based dynamic grace period extension
- Configurable grace period separate from hold duration
- Visual indicator changes during grace period
- Audio feedback when grace period ends
- Queuing interrupted recordings for later transcription
- Grace period cap/maximum

## Open Questions

None - all major questions resolved during interview.

## Implementation Notes

### Files to Modify

1. **ShortcutManager.swift**
   - Add `gracePeriodTimer: DispatchSourceTimer?` property
   - Add `isInGracePeriod: Bool` state
   - Modify key release handling to start timer instead of immediate stop
   - Add timer cancellation on key re-press
   - Add debug logging for grace period events

2. **Unit Tests**
   - Add `ShortcutManagerGracePeriodTests.swift` or extend existing tests
   - Test basic grace period timing
   - Test re-press cancellation
   - Test setting synchronization

### Code Sketch

```swift
// In ShortcutManager

private var gracePeriodTimer: DispatchSourceTimer?
private var isInGracePeriod = false

private func handleKeyRelease() {
    guard isRecording else { return }

    Logger.shared.debug("Key released, starting grace period of \(config.minimumHoldDuration)ms")
    isInGracePeriod = true

    gracePeriodTimer = DispatchSource.makeTimerSource(queue: .main)
    gracePeriodTimer?.schedule(deadline: .now() + .milliseconds(Int(config.minimumHoldDuration)))
    gracePeriodTimer?.setEventHandler { [weak self] in
        self?.gracePeriodEnded()
    }
    gracePeriodTimer?.resume()
}

private func gracePeriodEnded() {
    Logger.shared.debug("Grace period ended, stopping recording")
    isInGracePeriod = false
    gracePeriodTimer = nil
    delegate?.onRecordingStop()
}

private func handleKeyPress() {
    if isInGracePeriod {
        // Cancel grace period, continue recording
        Logger.shared.debug("Key re-pressed during grace period, continuing recording")
        gracePeriodTimer?.cancel()
        gracePeriodTimer = nil
        isInGracePeriod = false
        return
    }
    // ... normal key press handling
}
```

### Logging Format

```
[DEBUG] Key released, starting grace period of 300ms
[DEBUG] Grace period ended, stopping recording
```

Or for re-press:
```
[DEBUG] Key released, starting grace period of 300ms
[DEBUG] Key re-pressed during grace period, continuing recording
```
